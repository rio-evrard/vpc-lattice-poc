# VPC Lattice Vending Machine (PoC)

This repository contains the reference Terraform code and automation logic for the **"Lattice Vending Machine"** pattern. It serves as the technical companion to the Medium article:
**[VPC Lattice vs. Transit Gateway: A Hybrid Enterprise Strategy Implementation](https://medium.com/towards-aws/vpc-lattice-vs-transit-gateway-a-hybrid-enterprise-strategy-implementation-536e9b16b43e)**

> âš ï¸ **Note:** This repository is a **Reference Implementation**. The files contained herein are designed to be integrated into a larger, multi-account (Hub & Spoke) Terraform structure. They are not intended to be run as a single, standalone root module (`terraform apply`), but rather copied and adapted into your specific **Central Network**, **Provider**, and **Consumer** account repositories.

## ğŸ— Architecture

This project demonstrates an **Event-Driven "Opt-In" Network Model**. Instead of manual ticketing systems, we use infrastructure code and automation to allow spoke accounts to "vending" their own connectivity.

**The Workflow:**

1. **Provider Account:** Deploys a service and writes its ID to a Central Secrets Manager secret.
2. **Central Account:** An EventBridge rule detects the secret update and triggers a Lambda function.
3. **Automation:** The Lambda function reads the secret and performs the `CreateServiceNetworkServiceAssociation` API call, instantly bridging the service to the network.
4. **Consumer Account:** Reads the Network ID from a public secret and associates its VPC to start consuming services.

## ğŸ“‚ Repository Structure

The code is organized by logical function within the Terraform hierarchy.

```text
terraform
 â”£ ğŸ“‚ modules
 â”ƒ â”— ğŸ“‚ vpc-lattice-network       # Reusable Terraform Module for the Central Hub logic
 â”ƒ â”ƒ â”£ main.tf
 â”ƒ â”ƒ â”— variables.tf
 â”£ ğŸ“‚ vpc-lattice-network         # The "Central Account" Implementation
 â”ƒ â”£ ğŸ“‚ lambda_src
 â”ƒ â”ƒ â”— associator.py           # The Python logic for the "Glue" (Lambda)
 â”ƒ â”£ associator.zip            # Zipped artifact (generated by TF)
 â”ƒ â”£ automation.tf             # Defines Lambda, EventBridge, and IAM for Automation
 â”ƒ â”£ iam-roles.tf              # Cross-account Roles (Writer/Reader) for Secrets
 â”ƒ â”£ main.tf                   # Core Lattice Service Network resources
 â”ƒ â”— vpc_lattice_network.tf    # Module instantiation
 â”£ vpc-lattice-provider.tf     # Template for Service Provider Accounts (Spokes)
 â”— vpc-lattice-consumer.tf     # Template for Consumer Accounts (Spokes)
```

## ğŸš€ Integration Guide

To adapt this PoC into your environment, follow these three phases corresponding to your AWS account structure.

### Phase 1: The Central Hub (Network Account)

*Located in:* `terraform/vpc-lattice-network/`

This code acts as the "Brain" of the operation. It must be deployed in your **Central Network Account** (where your Transit Gateway or Core Network usually lives).

1. **Deploy the Automation:** The `automation.tf` file deploys the `associator` Lambda and the EventBridge rule that watches for secret updates.
2. **Create the Registries:** The Terraform creates two Secrets Manager secrets:
* `vpclattice_services` (The Provider Drop-box)
* `service_network_info` (The Consumer Phone-book)


3. **Setup IAM:** Ensure `iam-roles.tf` is applied to allow Spoke accounts to assume the `CentralNetworkSecretsWriter` and `CentralNetworkSecretsReader` roles.

### Phase 2: The Service Provider (Spoke Account)

*Reference file:* `terraform/vpc-lattice-provider.tf`

Copy this logic into the Terraform repository of any application team that wants to **share** a service.

1. **Define the Service:** Uses the `aws_vpclattice_service` resource to define listeners and targets (Lambda/EC2/ALB).
2. **The "Registration Hook":** The crucial part is the `aws_secretsmanager_secret_version` resource. This writes the Service ID and RAM Share ARN into the Central Account's secret, triggering the automation defined in Phase 1.
3. **Dependencies:** Ensure the provider alias `central_network_writer` is configured to assume the role created in Phase 1.

### Phase 3: The Consumer (Spoke Account)

*Reference file:* `terraform/vpc-lattice-consumer.tf`

Copy this logic into the Terraform repository of any application team that needs to **consume** services.

1. **Discovery:** Uses a Data Source to read the `service_network_info` secret from the Central Account.
2. **Association:** Creates an `aws_vpclattice_service_network_vpc_association` to link their VPC to the global mesh.
3. **Security:** Includes a boilerplate Security Group to allow traffic to the Lattice Link-Local range (`169.254.171.0/24`).

## ğŸ›  Prerequisites

* **AWS Organization:** You need at least 2 AWS accounts (Hub and Spoke) to test the cross-account logic.
* **AWS RAM:** Resource Access Manager must be enabled in your Organization to share the Service Network and Services.

## ğŸ”— References

* **Blog Post:** [VPC Lattice vs. Transit Gateway: A Hybrid Enterprise Strategy Implementation](https://medium.com/towards-aws/vpc-lattice-vs-transit-gateway-a-hybrid-enterprise-strategy-implementation-536e9b16b43e)
* **AWS Documentation:** [What is Amazon VPC Lattice?](https://docs.aws.amazon.com/vpc-lattice/latest/ug/what-is-vpc-lattice.html)